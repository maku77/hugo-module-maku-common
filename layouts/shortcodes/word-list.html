{{- $words_dir := .Get 0 }}
{{- $data := index $.Site.Data $words_dir }}
{{- $words := index $data "definitions" }}

<style>
  .local-wordCount {
    text-align: right;
  }
  .local-copied {
    {{- if hugo.IsServer }}
      color: gray;
      background: #eee;
      border-radius: 0.3em;
    {{- end }}
  }
  .local-ref {
  }
  .local-synonyms {
    color: #666;
    font-weight: normal;
    margin-left: 3em;
  }
  .local-synonyms::before {
    content: 'ï¼';
    margin-right: 0.2em;
  }
  dt {
    color: #dd3300;
    font-weight: bolder;
  }
  dt > .en, dt > .jp {
    margin-left: 0.5em;
    color: gray;
    font-weight: normal;
    font-style: italic;
  }
  dt > .index {
    color: lightgray;
    font-weight: normal;
    font-size: smaller;
  }
  dt > .tag {
    margin-left: 0.5em;
    color: gray;
    font-size: smaller;
    font-weight: normal;
    vertical-align: middle;
    border: solid 1px lightgray;
    border-radius: 1em;
    padding: 0.1em 0.7em;
    background: #efefef;
  }
  dd {
    color: #333;
    margin-top: 0.3em;
    font-weight: normal;
  }
  .local-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
  }
  .local-buttons button {
    padding: 0.4em 0.6em;
    gap: 0.5em;
    border: solid 1px #ddd;
  }
</style>

<div class="local-wordCount">
  ç™»éŒ²æ•°: {{ len $words }}ï¼ˆéšæ™‚è¿½åŠ ä¸­ï¼‰
</div>

<!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒœã‚¿ãƒ³ -->
<div>
  {{- $categories := slice "ALL" }}
  {{- range $words }}
    {{ $categories = $categories | append (partial "functions/inline-getCategory" .) }}
  {{- end }}
  <div class="local-buttons">
  {{- range (uniq $categories) }}
    <button class="local-button" onclick="location.hash = 'category={{ . }}'">{{ . }}</button>
  {{- end }}
  </div>
</div>

<dl>
  {{- range $index, $elem := $words }}
    {{- /* desc ã‚‚ copy ã‚‚å®šç¾©ã•ã‚Œã¦ã„ãªã„å˜èªãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}}
    {{- if and (not (isset . "desc")) (not (isset . "copy")) }}
      {{- errorf "Word \"%s (%s)\" has neither `.desc` nor `.copy`." .label .id  }}
    {{- end }}

    {{- /* copy ãŒå®šç¾©ã•ã‚Œã¦ã„ãŸã‚‰ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å˜èªå®šç¾©ã® descã€tagsã€antonymsã€related ã‚’æ¡ç”¨ */}}
    {{- $desc := .desc }}
    {{- $tags := .tags }}
    {{- $antonyms := .antonyms }}
    {{- $related := .related }}

    {{- /* å˜èªã® yomi æƒ…å ±ã‹ã‚‰ "ã‚è¡Œ" ãªã©ã®ã‚«ãƒ†ã‚´ãƒªåã‚’ç”Ÿæˆ */}}
    {{- $category := partial "functions/inline-getCategory" $elem }}

    {{- with .copy }}
      {{- $copiedWord := index (first 1 (where $words "id" "==" .)) 0 }}
      {{- if $copiedWord }}
        {{- $desc = $copiedWord.desc }}
        {{- $tags = $copiedWord.tags }}
        {{- $antonyms = $copiedWord.antonyms }}
        {{- $related = $copiedWord.related }}

        {{- if $elem.desc }}
          {{- errorf "\"%s (%s)\" ã«ã¯ `.copy` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã« `.desc` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚" $elem.label $elem.id }}
        {{- end }}
        {{- if $elem.tags }}
          {{- errorf "\"%s (%s)\" ã«ã¯ `.copy` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã« `.tags` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚" $elem.label $elem.id }}
        {{- end }}
        {{- if $elem.antonyms }}
          {{- errorf "\"%s (%s)\" ã«ã¯ `.copy` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã« `.antonyms` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚" $elem.label $elem.id }}
        {{- end }}
        {{- if $elem.related }}
          {{- errorf "\"%s (%s)\" ã«ã¯ `.copy` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã« `.related` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚" $elem.label $elem.id }}
        {{- end }}
      {{- else }}
        {{- errorf "\"%s (%s)\" ã® `.copy` ã«è¨­å®šã•ã‚ŒãŸ `%s` ã¨ã„ã† ID ã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" $elem.label $elem.id . }}
      {{- end }}
    {{- end }}

    <dt data-category="{{ $category }}">
      {{- with .id }}<a id="{{ . }}"></a>{{ end }}
      <span class="index">{{ add $index 1 }}. </span>
      {{ .label }}
      {{- with .yomi }}ï¼ˆ{{ . }}ï¼‰{{ end }}
      {{- with .english }}<span class="en">{{ . }}</span>{{ end }}
      {{- with .japanese }}<span class="jp">{{ . }}</span>{{ end }}
      {{- range $tags }}<span class="tag">{{ . }}</span>{{ end }}
      {{- with .synonyms }}
        <div class="local-synonyms">{{ . | markdownify }}</div>
      {{- end }}
    </dt>
    <dd{{ if .copy }} class="local-copied"{{ end }} data-category="{{ $category }}">
      {{- with $desc }}{{ . | markdownify }}{{ end }}

      {{- with $antonyms }}
        <div class="local-ref">ğŸ“•å¯¾ç¾©èª: {{ . | markdownify }}</div>
      {{- end }}

      {{- with $related }}
        <div class="local-ref">ğŸ“—é–¢é€£ç”¨èª: {{ . | markdownify }}</div>
      {{- end }}

      {{- range .pages }}
        <div class="local-ref">ğŸ“˜å‚è€ƒãƒšãƒ¼ã‚¸: <a href="{{ .pid }}">{{ .title }}</a></div>
      {{- end }}

      {{- with .more }}
        <div class="local-ref"><a href="{{ . | relURL }}">ğŸ“˜ã‚‚ã£ã¨è©³ã—ã</a></div>
      {{- end }}
    </dt>
  {{- end }}
</dl>

<script>
// é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒœã‚¿ãƒ³ã ã‘ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
function highlightButton(category) {
  const buttons = document.querySelectorAll('button')
  buttons.forEach((b) => {
    if (b.textContent === category) {
      b.style.background = '#faa'
    } else {
      b.style.background = ''
    }
  })
}

// ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆhighlightButton('ALL') ã‚’ä½¿ã†ã®ã§ç¾çŠ¶ã“ã‚Œã¯ä½¿ã‚ãªã„ï¼‰
// function clearButtonHighlight() {
//   const buttons = document.querySelectorAll('button')
//   buttons.forEach((b) => b.style.background = '')
// }

// æŒ‡å®šã•ã‚ŒãŸ ID ã®å˜èªã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
function scrollToElemId(elemId) {
  const targetElem = document.getElementById(elemId)
  const targetPosition = targetElem.getBoundingClientRect().top
  const offsetPosition = window.pageYOffset + targetPosition
  window.scrollTo({ top: offsetPosition, behavior: "smooth" })
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã‚ˆã‚‹å˜èªã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
function filterCategory(category) {
  // ã‚«ãƒ†ã‚´ãƒªãƒ¼å±æ€§ (data-category) ã®ã¤ã„ãŸè¦ç´ ã‚’ã™ã¹ã¦éè¡¨ç¤ºã«ã™ã‚‹
  const elems = document.querySelectorAll(`[data-category]`)
  elems.forEach((e) => e.style.display = 'none')

  // ãã®å†…ã€å¼•æ•°ã§æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã‚‚ã®ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
  const selectedElems = document.querySelectorAll(`[data-category='${category}']`);
  selectedElems.forEach((e) => e.style.display = 'block')
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
function clearFilter() {
  // ã™ã¹ã¦ã®ç”¨èªã‚’è¡¨ç¤º (display: block)
  const elems = document.querySelectorAll(`[data-category]`)
  elems.forEach((e) => e.style.display = 'block')
}

// ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ãšã«ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
function clearHash() {
  const newUrl = window.location.href.split('#')[0];
  history.pushState(null, null, newUrl);
}

// ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã®å¤‰åŒ–ã§ã„ã‚ã„ã‚å‡¦ç†ï¼ˆã“ã‚ŒãŒãƒ¡ã‚¤ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰
function handleHashChanged() {
  const hash = decodeURI(location.hash.substring(1))
  const [_, category] = hash.split('category=')

  if (category === 'ALL') { // ALL ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
    clearFilter()
    highlightButton('ALL')
    clearHash()  // URL ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãªçŠ¶æ…‹ã«ã™ã‚‹
  } else if (category) {  // ALL ä»¥å¤–ã®ã‚«ãƒ†ã‚´ãƒªãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
    filterCategory(category)
    highlightButton(category)
  } else if (hash) {  // ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
    clearFilter()
    highlightButton('ALL')

    // ã‚¸ãƒ£ãƒ³ãƒ—å…ˆã®å˜èªãŒä¸Šè¨˜ã«ã‚ˆã‚Šè¡¨ç¤ºã•ã‚Œã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦
    // setTimeout(() => scrollToElemId(hash), 500)
    scrollToElemId(hash)
  } else {  // ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰
    highlightButton('ALL')
  }
}

// ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã®å¤‰åŒ–ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ï¼ˆãƒšãƒ¼ã‚¸ã®åˆæœŸè¡¨ç¤ºæ™‚ã‚‚åŒã˜å‡¦ç†ã‚’å®Ÿè¡Œï¼‰
window.addEventListener('hashchange', handleHashChanged)
window.addEventListener('DOMContentLoaded', handleHashChanged)
</script>

{{- define "partials/functions/inline-getCategory" }}
  {{ $word := . }}
  {{ $category := "ãã®ä»–" }}
  {{ $firstChar := substr $word.yomi 0 1 }}

  {{ if not $firstChar }}
    {{/* $category ã¯ "ãã®ä»–" ã®ã¾ã¾ */}}
  {{ else if in "ã‚ ã„ ã† ãˆ ãŠ" $firstChar }}
    {{ $category = "ã‚è¡Œ" }}
  {{ else if in "ã‹ ã ã ã‘ ã“ ãŒ ã ã ã’ ã”" $firstChar }}
    {{ $category = "ã‹è¡Œ" }}
  {{ else if in "ã• ã— ã™ ã› ã ã– ã˜ ãš ãœ ã" $firstChar }}
    {{ $category = "ã•è¡Œ" }}
  {{ else if in "ãŸ ã¡ ã¤ ã¦ ã¨ ã  ã¢ ã¥ ã§ ã©" $firstChar }}
    {{ $category = "ãŸè¡Œ" }}
  {{ else if in "ãª ã« ã¬ ã­ ã®" $firstChar }}
    {{ $category = "ãªè¡Œ" }}
  {{ else if in "ã¯ ã² ãµ ã¸ ã» ã° ã³ ã¶ ã¹ ã¼ ã± ã´ ã· ãº ã½" $firstChar }}
    {{ $category = "ã¯è¡Œ" }}
  {{ else if in "ã¾ ã¿ ã‚€ ã‚ ã‚‚" $firstChar }}
    {{ $category = "ã¾è¡Œ" }}
  {{ else if in "ã‚„ ã‚† ã‚ˆ" $firstChar }}
    {{ $category = "ã‚„è¡Œ" }}
  {{ else if in "ã‚‰ ã‚Š ã‚‹ ã‚Œ ã‚" $firstChar }}
    {{ $category = "ã‚‰è¡Œ" }}
  {{ else if in "ã‚ ã‚’ ã‚“" $firstChar }}
    {{ $category = "ã‚è¡Œ" }}
  {{ end }}

  {{ return $category }}
{{- end }}

